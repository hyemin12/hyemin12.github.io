---
title: ë°ë¸Œì½”ìŠ¤ TIL - Day 27
date: 2023-12-25 16:24:00  +09:00
categories: ["ë°ë¸Œì½”ìŠ¤", "TIL"]
tags: []
toc: true
toc_sticky: true
---

##### 23ë…„ 12ì›” 25ì¼ ê°•ì˜ë¥¼ ë“¤ì€ ë‚´ìš©ì„ ê¸°ë¡í•œ ê¸€ì…ë‹ˆë‹¤.

## ğŸ“’ì¸ì¦, ì¸ê°€

### ì¸ì¦ (Authentication)

ì¸ì¦ì€ ì‹ ì›ì„ í™•ì¸í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ì…ë‹ˆë‹¤.  
ë¹„ë°€ë²ˆí˜¸, í•˜ë“œì›¨ì–´ í† í°, ê¸°íƒ€ ì—¬ëŸ¬ ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

### ì¸ê°€ (Authorization)

ì¸ê°€ëŠ” ì¸ì¦ ì´í›„ì˜ í”„ë¡œì„¸ìŠ¤ì…ë‹ˆë‹¤. ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì–´ë– í•œ ìì›ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” ì ˆì°¨ê°€ ë°”ë¡œ ì¸ê°€ì´ë‹¤.

#### ë¹„êµ

- ì‚¬ì´íŠ¸ì— ê°€ì…ëœ ì‚¬ìš©ìë¼ëŠ” ê²ƒì„ ì¦ëª…í•˜ëŠ” ê²ƒì€ ì¸ì¦
- ì¸ì¦ í›„ì— í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì€ ì¸ê°€

## Stateless

## ğŸ“’ ì¿ í‚¤, ì„¸ì…˜, JWT

ë¡œê·¸ì¸ì„ ìœ ì§€ì‹œí‚¬ ë•Œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ë“¤

### 1. ì¿ í‚¤

HTTP ì¿ í‚¤ë€ ì„œë²„ì—ì„œ ì‚¬ìš©ì ë¸Œë¼ìš°ì €ë¡œ ì „ì†¡í•˜ëŠ” ì‘ì€ ë°ì´í„°ë¥¼ ëœ»í•œë‹¤.  
ë¸Œë¼ìš°ì €ëŠ” ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°(Cookie)ë¥¼ ì €ì¥í•´ ë†“ì•˜ë‹¤ê°€ ë™ì¼í•œ ì„œë²„ë¡œ ì¬ìš”ì²­ ì‹œ ì œê³µë°›ì•˜ë˜ ë°ì´í„°ë¥¼ í•¨ê»˜ ì „ì†¡í•œë‹¤. ì´ë¥¼ í†µí•´ HTTPì˜ statelessë¥¼ ë³´ì™„í•´ HTTP í†µì‹ ì—ì„œë„ ìƒíƒœ ì •ë³´ë¥¼ ë³´ì¡´í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤

#### â–  ì¿ í‚¤ë¥¼ ì‚¬ìš©í•œ ë¡œê·¸ì¸ ê¸°ëŠ¥

ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•  ë•Œ  
**ì„œë²„ëŠ” IDì™€ PWë¥¼ Cookieì— ë‹´ì•„ ì‘ë‹µí•˜ê³ ,  
ì´í›„ ìš”ì²­ë¶€í„°ëŠ” ë¸Œë¼ìš°ì €ê°€ ID/PWë¥¼ Cookieì— ë‹´ì•„ í•¨ê»˜ ë³´ë‚´ê¸° ë•Œë¬¸ì—**,  
ì¸ì¦/ì¸ê°€ë¥¼ ìœ„í•´ ë§¤ë²ˆ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ë˜ê²Œ ëœë‹¤.

#### â–  ì¥ì 

- ê¸°ì¡´ ë¡œê·¸ì¸ì„ ìœ„í•œ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì¸ì¦/ì¸ê°€ë¥¼ ìœ„í•œ ì¶”ê°€ì ì¸ ë°ì´í„° ì €ì¥ì´ í•„ìš” ì—†ë‹¤.
- ì„œë²„ì— ì •ë³´ë¥¼ ì €ì¥í•˜ì§€ ì•Šê¸°ë•Œë¬¸ì— ì„œë²„ ì €ì¥ ê³µê°„ì´ í•„ìš” ì—†ê³ , Statelessí•˜ë‹¤ê³  í•  ìˆ˜ ìˆë‹¤.

#### â–  ë‹¨ì 

- ì‚¬ìš©ìì˜ ì£¼ìš” ì •ë³´ë¥¼ ë§¤ë²ˆ ìš”ì²­ì— ë‹´ì•„ì•¼ í•˜ê¸°ì— ë³´ì•ˆì´ ì·¨ì•½í•˜ë‹¤.

### 2. ì„¸ì…˜

![https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FQFFUP%2FbtrNdTUj8TF%2FOyw4ar5S7aDFaFCKTaIyc1%2Fimg.png](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FQFFUP%2FbtrNdTUj8TF%2FOyw4ar5S7aDFaFCKTaIyc1%2Fimg.png)

ì¿ í‚¤ì˜ ì·¨ì•½í•œ ë³´ì•ˆì„ í•´ê²°í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì„¸ì…˜
Sessionì€ ê³ ê°ì˜ ì£¼ìš” ì •ë³´ê°€ ì•„ë‹Œ, ë‹¨ì§€ ê³ ê°ì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ê°’ ìƒì„±í•´ Cookieë¡œ ì£¼ê³ ë°›ëŠ”ë‹¤.

#### â–  ì„¸ì…˜ë¥¼ ì‚¬ìš©í•œ ë¡œê·¸ì¸ ê¸°ëŠ¥

A ì‚¬ìš©ìê°€ ID/PWë¥¼ í†µí•´ ë¡œê·¸ì¸ì„ í–ˆë‹¤ë©´  
Aì‚¬ìš©ìë¥¼ **ì‹ë³„í•  ìˆ˜ ìˆëŠ” ê°’ë¥¼ ìƒì„±í•´ Cookieë¡œ ë¸Œë¼ìš°ì €ì— ì‹¬ê³  ë§¤ë²ˆ ìš”ì²­ ë•Œë§ˆë‹¤ ìƒì„±í•œ ê°’ì„ í†µí•´ ì¸ì¦/ì¸ê°€ë¥¼ ìë™ìœ¼ë¡œ ì§„í–‰**í•œë‹¤.  
ì´ ë•Œ ìƒì„±ë˜ëŠ” **ì‚¬ìš©ì ì‹ë³„ ê°’ì„ Session ID**ë¼ í•œë‹¤.

#### â–  ì¥ì 

- ì¿ í‚¤ë³´ë‹¤ ë³´ì•ˆì´ ë¹„êµì  ì¢‹ë‹¤.

#### â–  ë‹¨ì 

- ì‚¬ìš©ìë¥¼ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ê°’ì„ ìƒì„±í•˜ê³  ì„œë²„ì— ì €ì¥í•´ë‘ì–´ì•¼ í•œë‹¤.
- ì„œë²„ ì €ì¥ ê³µê°„ì´ í•„ìš”í•˜ë‹¤.
- Statelessí•˜ë‹¤ê³  í‘œí˜„í•  ìˆ˜ ì—†ë‹¤. (ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ë•Œë¬¸ì—)

### token?

ì‚¬ìš©ìë¥¼ ì¸ì¦í•  ìˆ˜ ìˆëŠ” ì •ë³´ê°€ **ìˆ¨ê²¨ì§„ ì•”í˜¸í™”ëœ Access Tokenì„ ë°œí–‰**í•˜ê³ , **ì¸ì¦ì´ í•„ìš”í•  ë•Œë§ˆë‹¤ ì„œë²„ì— Tokenê³¼ í•¨ê»˜ ìš”ì²­**ì„ ë³´ë‚¸ë‹¤. **ì„œë²„ëŠ” ì €ì¥ëœ ë°ì´í„°ê°€ ì•„ë‹Œ Token í•´ë…ì„ í†µí•´** Token ì†ì—ì„œ ì‚¬ìš©ìë¥¼ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ì •ë³´ë“¤ì„ ì•Œì•„ë‚´ê³  ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¸ì¦/ì¸ê°€ê°€ ìë™ìœ¼ë¡œ ì§„í–‰í•œë‹¤.

### 3. JWT (Json Web Token)

JSON í˜•íƒœì˜ ë°ì´í„°ë¥¼ ì•ˆì •í•˜ê²Œ ì „ì†¡í•˜ê¸° ìœ„í•œ í† í°

[jwt ê³µì‹ ë¬¸ì„œ](https://jwt.io/)

#### â–  JWT êµ¬ì¡°

![https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FcMNg1I%2FbtrNhSfsmXs%2FtMK1UkKEq3BPAZ96kF6k7k%2Fimg.png](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FcMNg1I%2FbtrNhSfsmXs%2FtMK1UkKEq3BPAZ96kF6k7k%2Fimg.png)

- Header: í† í°ì„ ì•”í˜¸í™”í•˜ëŠ”ë° ì‚¬ìš©í•œ ì•Œê³ ë¦¬ì¦˜, í† í° í˜•íƒœ
- PAYLOAD: ì‚¬ìš©ì ì •ë³´
  - sub: í† í° ì œëª©
  - iat: ì–¸ì œ ë°œê¸‰ë˜ì—ˆëŠ”ì§€
- SIGNATURE: ì•”í˜¸í™”ë¥¼ ìœ„í•œ ë°ì´í„°,
  - MY_SECRET_KEY : ì„œë²„ë§Œ ì•Œê³  ìˆê³ , ì„œë²„ì™€ ë¹„êµí•˜ì—¬ ìœ íš¨ì„± ê²€ì‚¬í•  ë°ì´í„°

#### â–  í† í° ì‚¬ìš©í•œ ë¡œê·¸ì¸ ê¸°ëŠ¥

![loginflow](https://github.com/hyemin12/hyemin12.github.io/assets/66300732/8d1bfd1a-0428-43ce-98a0-4e926d34bf8d)

ì„œë¹„ìŠ¤ì— ë¡œê·¸ì¸ ìš”ì²­ì„ í•˜ë©´ ì„œë¹„ìŠ¤ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œ í† í°ì„ ë°œê¸‰í•˜ê³ , ì „ë‹¬í•œë‹¤.  
í´ë¼ì´ì–¸íŠ¸ëŠ” ë°œê¸‰ë°›ì€ í† í°ì„ ë³´ê´€í•˜ê³  ìˆë‹¤ê°€ í† í°ì„ ì‚¬ìš©í•´ ì¸ì¦/ì¸ê°€ë¥¼ ìš”ì²­í•œë‹¤.

#### â–  í† í° ì‚¬ìš©í•œ ë¡œê·¸ì¸ ê¸°ëŠ¥ - ì‹¤ì œ ì„œë¹„ìŠ¤

![loginflow2](https://github.com/hyemin12/hyemin12.github.io/assets/66300732/2421088d-fbf4-4323-8987-07a431678c99)

#### â–  ì¥ì 

- ì•”í˜¸í™”ëœ í† í°ì´ê¸° ë•Œë¬¸ì— ë³´ì•ˆì— ê°•í•˜ë‹¤.
- Statelessí•˜ë‹¤. (ì„œë°”ê°€ ìƒíƒœë¥¼ ì €ì¥í•˜ì§€ ì•ŠìŒ)
- ì„œë²„ì— ë¶€ë‹´ì„ ì¤„ì—¬ì¤„ ìˆ˜ ìˆë‹¤.

## ì‹¤ìŠµ

### #JWT êµ¬í˜„í•´ë³´ê¸°

[npm - jsonwebtoken](https://www.npmjs.com/package/jsonwebtoken)

#### #ì„¤ì¹˜ ëª…ë ¹ì–´

`npm i jsonwebtoken`

### #ëª¨ë“ˆ ë¶ˆëŸ¬ì˜¤ê¸°

- `sign`: token ë°œí–‰
- `sign(í˜ì´ë¡œë“œ, ì•”í˜¸í‚¤) + SHA256`

```js
const jwt = require("jsonwebtoken");
const token = jwt.sign({ foo: "bar" }, "shhhhh");

console.log(token);
// eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmb28iOiJiYXIiLCJpYXQiOjE3MDM0NjkyOTh9.aK-o_-G_0fYbnI4G5rbB9IZ5m6lp1etGSNK1LU8E_88
```

### #token ê²€ì¦í•˜ê¸°

- `verify`: token ë³µí˜¸í™”
- `verify(token, ì•”í˜¸í‚¤)`

```js
const jwt = require("jsonwebtoken");
const token = jwt.sign({ foo: "bar" }, "shhhhh");

const decoded = jwt.verify(token, "shhhhh");
console.log(decoded);
// { foo: 'bar', iat: 1703469696 }
```

### #.env íŒŒì¼ì„ ë§Œë“¤ê³ , í™˜ê²½ ë³€ìˆ˜ ìˆ¨ê¸°ê¸°

#### 1. dotenv íŒ¨í‚¤ì§€ ì„¤ì¹˜

`npm i dotenv`

#### 2. .env íŒŒì¼ ë§Œë“¤ê³ , í™˜ê²½ ë³€ìˆ˜ ì €ì¥í•˜ê¸°

```bash
# ë””ë ‰í† ë¦¬
â”œâ”€â”€ .env
â”œâ”€â”€ .gitignore
â””â”€â”€ jwt-demo.js
```

- .env : í™˜ê²½ ë³€ìˆ˜ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ íŒŒì¼
- .gitignore : github ì—…ë¡œë“œì‹œ ë¬´ì‹œí•  íŒŒì¼ë“¤ì„ ì„¤ì •í•˜ëŠ” íŒŒì¼

```js
// .env
const
```

#### 3. í™˜ê²½ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  íŒŒì¼ì—ì„œ dotenv ëª¨ë“ˆì„ ê°€ì ¸ì˜¤ê³ , `process.env`ë¥¼ ì‚¬ìš©í•´ì„œ í™˜ê²½ ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°

```js
// jwt-demo.js

const jwt = require("jsonwebtoken");
const dotenv = require("dotenv");

dotenv.config();

const PRIVATE_KEY = process.env.PRIVATE_KEY;
const token = jwt.sign({ foo: "bar" }, PRIVATE_KEY);

const decoded = jwt.verify(token, PRIVATE_KEY);

console.log(decoded);
```

### #ì‹¤ìŠµ - ìœ íŠœë¸Œì— jwt ì ìš©í•˜ê¸°

#### â–  token cookieì— ë‹´ì•„ì„œ ë³´ë‚´ê¸°

```js
res.cookie("token", token);
```

â€» ë‚˜ì¤‘ì— reqì—ì„œ cookieë¥¼ í™•ì¸í•  ë•Œ parserë¥¼ ì‚¬ìš©í•´ì•¼ í•¨!

#### â–  httpOnly ì†ì„± ë³€ê²½í•˜ê¸°

```js
res.cookie("token", token, { httpOnly: true });
```

#### â–  token ìœ íš¨ê¸°ê°„ ì„¤ì •í•˜ê¸°

- `expiresIn`

```js
const token = jwt.sign({ email, name: matchedEmail.name }, TOKEN_PRIVATE_KEY, {
  expiresIn: "1h",
  issuer: "hyemin"
});
```

ê²°ê³¼
![ìœ íš¨ê¸°ê°„](https://github.com/hyemin12/hyemin12.github.io/assets/66300732/d6b7fa91-64d5-4b5e-b018-3aedd5e79cc3)

#### ì „ì²´ ì½”ë“œ

```js
const express = require("express");
const router = express.Router();
const conn = require("../mysql");
const { body, validationResult } = require("express-validator");

const jwt = require("jsonwebtoken");
const dotenv = require("dotenv");

dotenv.config();

const TOKEN_PRIVATE_KEY = process.env.PRIVATE_KEY;

router.use(express.json());

const validationBodyEmail = body("email")
  .notEmpty()
  .isEmail()
  .withMessage("ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
const validationBodyName = body("name")
  .notEmpty()
  .isString()
  .withMessage("ìœ ì € ì´ë¦„ì€ ë¬¸ìì—¬ì•¼í•©ë‹ˆë‹¤.");
const validationBodyContact = body("contact")
  .notEmpty()
  .isString()
  .withMessage("ì „í™”ë²ˆí˜¸ í™•ì¸í•´ì£¼ì„¸ìš”");
const validationBodyPassword = body("pwd")
  .notEmpty()
  .isString()
  .withMessage("ë¹„ë°€ë²ˆí˜¸ í™•ì¸í•´ì£¼ì„¸ìš”");

const validate = (req, res, next) => {
  const err = validationResult(req);
  if (err.isEmpty()) return next();
  return res.status(400).send(err.array());
};

const checkSqlError = (err, res) => {
  if (err) {
    console.log(err);
    return res.status(400).end();
  }
};

router.post(
  "/join",
  [
    validationBodyEmail,
    validationBodyName,
    validationBodyPassword,
    validationBodyContact,
    validate
  ],
  (req, res, next) => {
    const { email, pwd, name, contact } = req.body;
    const sql =
      "INSERT INTO users (email,name,password,contact) VALUES (?,?,?,?)";
    const values = [email, name, pwd, contact];

    conn.query(sql, values, (err, results, fields) => {
      checkSqlError(err, res);
      res.status(201).send({ message: `${name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤.` });
    });
  }
);
router.post(
  "/login",
  [validationBodyEmail, validationBodyPassword, validate],
  (req, res, next) => {
    const { email, pwd } = req.body;
    const sql = "SELECT * FROM users WHERE email = ?";
    conn.query(sql, email, (err, results) => {
      checkSqlError(err, res);

      const [matchedEmail] = results;

      if (matchedEmail) {
        if (matchedEmail.password === pwd) {
          const token = jwt.sign(
            { email, name: matchedEmail.name },
            TOKEN_PRIVATE_KEY,
            {
              expiresIn: "1h",
              issuer: "hyemin"
            }
          );

          res.cookie("token", token, {
            httpOnly: true
          });
          console.log(token);

          res
            .status(200)
            .send({ message: `${matchedEmail.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤.` });
        } else {
          res.status(403).send({ message: "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
        }
      } else {
        res.status(403).send({ message: "ì¼ì¹˜í•˜ëŠ” ì•„ì´ë””ê°€ ì—†ìŠµë‹ˆë‹¤." });
      }
    });
  }
);

router
  .route("/users")
  .get([validationBodyEmail, validate], (req, res) => {
    const { email } = req.body;
    const sql = "SELECT * FROM users WHERE email = (?)";

    conn.query(sql, [email], (err, results) => {
      checkSqlError(err, res);

      if (results.length > 0) {
        res.status(200).send(results[0]);
      } else {
        res.status(404).send({ message: "ì¼ì¹˜í•˜ëŠ” ì•„ì´ë””ê°€ ì—†ìŠµë‹ˆë‹¤." });
      }
    });
  })
  .delete([validationBodyEmail, validate], (req, res) => {
    const { email } = req.body;
    const sql = "DELETE FROM users WHERE email = ? ";

    conn.query(sql, [email], (err, results) => {
      checkSqlError(err, res);

      if (results.affectedRows > 0) {
        res.status(200).send(results);
      } else {
        res.status(400).end();
      }
    });
  });

module.exports = router;
```

ì°¸ê³  ì‚¬ì´íŠ¸

[ì§€ë§ˆì¼“ ê¸°ìˆ  ë¸”ë¡œê·¸ - ì¸ì¦/ì¸ê°€ëŠ” ì–´ë””ì— ì–´ë–»ê²Œ êµ¬í˜„í•´ì•¼ í• ê¹Œ?](https://dev.gmarket.com/45)
